<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICT và SRV tiếp tục chắp cánh tương lai cho sinh viên Công nghệ Thông tin và Truyền thông năm 2025</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; }
        .navbar-brand { font-weight: bold; }
        .article-img { max-width: 100%; height: auto; }
        .sidebar { border-left: 1px solid #ddd; padding-left: 20px; }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">SICT HAUI</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <%
                        // JDBC Connection
                        Connection conn = null;
                        Statement stmt = null;
                        ResultSet rs = null;
                        try {
                            Class.forName("com.microsoft.sqlserver.jdbc.SQLServerDriver");
                            String dbURL = "jdbc:sqlserver://localhost:1433;databaseName=SICT_HAUI;user=sa;password=yourpassword;encrypt=true;trustServerCertificate=true";
                            conn = DriverManager.getConnection(dbURL);
                            stmt = conn.createStatement();

                            // Fetch main categories (TheLoai) for navigation
                            String sqlTheLoai = "SELECT * FROM TheLoai WHERE VisibleTheLoai = 1 ORDER BY SapXep";
                            rs = stmt.executeQuery(sqlTheLoai);
                            while (rs.next()) {
                                int maTheLoai = rs.getInt("MaTheLoai");
                                String tenTheLoai = rs.getString("TenTheLoai");
                                String url = rs.getString("Url");
                                String target = rs.getString("Target");
                                boolean linkNgoai = rs.getBoolean("LinkNgoai");
                    %>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="<%= linkNgoai && url != null ? url : '#' %>" 
                           <%= linkNgoai && target != null ? "target=\"" + target + "\"" : "" %> 
                           id="navbarDropdown<%= maTheLoai %>" role="button" 
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <%= tenTheLoai %>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown<%= maTheLoai %>">
                            <%
                                // Fetch subcategories (TheLoaiTin) for each main category
                                Statement stmtSub = conn.createStatement();
                                String sqlTheLoaiTin = "SELECT * FROM TheLoaiTin WHERE MaTheLoai = " + maTheLoai + " AND VisibleTheLoaiTin = 1 ORDER BY SapXep";
                                ResultSet rsSub = stmtSub.executeQuery(sqlTheLoaiTin);
                                while (rsSub.next()) {
                                    String tenTheLoaiTin = rsSub.getString("TenTheLoaiTin");
                                    String urlSub = rsSub.getString("Url");
                                    String targetSub = rsSub.getString("Target");
                                    boolean linkNgoaiSub = rsSub.getBoolean("LinkNgoai");
                            %>
                            <li><a class="dropdown-item" href="<%= linkNgoaiSub && urlSub != null ? urlSub : '#' %>"
                                   <%= linkNgoaiSub && targetSub != null ? "target=\"" + targetSub + "\"" : "" %>>
                                <%= tenTheLoaiTin %>
                            </a></li>
                            <%
                                }
                                rsSub.close();
                                stmtSub.close();
                            %>
                        </ul>
                    </li>
                    <%
                            }
                            rs.close();
                        } catch (Exception e) {
                            out.println("Error: " + e.getMessage());
                        } finally {
                            if (stmt != null) stmt.close();
                            if (conn != null) conn.close();
                        }
                    %>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <!-- Article Content -->
            <div class="col-md-8">
                <%
                    // Fetch the news article (TinTuc) with MaTinTuc = 71346
                    conn = null;
                    stmt = null;
                    rs = null;
                    try {
                        Class.forName("com.microsoft.sqlserver.jdbc.SQLServerDriver");
                        String dbURL = "jdbc:sqlserver://localhost:1433;databaseName=SICT_HAUI;user=sa;password=yourpassword;encrypt=true;trustServerCertificate=true";
                        conn = DriverManager.getConnection(dbURL);
                        stmt = conn.createStatement();

                        String sqlTinTuc = "SELECT * FROM TinTuc WHERE MaTinTuc = 71346";
                        rs = stmt.executeQuery(sqlTinTuc);
                        if (rs.next()) {
                            String tieuDe = rs.getString("TieuDeTinTuc");
                            String urlAnh = rs.getString("UrlAnh");
                            String trichDan = rs.getString("TrichDanTin");
                            String noiDung = rs.getString("NoiDungTin");
                            String ngayCapNhat = rs.getString("NgayCapNhat");
                            int soLanDoc = rs.getInt("SoLanDoc");
                %>
                <h1><%= tieuDe %></h1>
                <p><small class="text-muted">Cập nhật: <%= ngayCapNhat %> | Lượt xem: <%= soLanDoc %></small></p>
                <% if (urlAnh != null && !urlAnh.isEmpty()) { %>
                    <img src="<%= urlAnh %>" alt="Article Image" class="article-img mb-3">
                <% } %>
                <p><strong><%= trichDan %></strong></p>
                <div><%= noiDung %></div>
                <%
                        } else {
                            out.println("<p>Bài viết không tồn tại.</p>");
                        }
                        rs.close();
                    } catch (Exception e) {
                        out.println("Error: " + e.getMessage());
                    } finally {
                        if (stmt != null) stmt.close();
                        if (conn != null) conn.close();
                    }
                %>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4 sidebar">
                <h4>Video Nổi Bật</h4>
                <%
                    // Fetch a video (VideoClip) for the sidebar
                    conn = null;
                    stmt = null;
                    rs = null;
                    try {
                        Class.forName("com.microsoft.sqlserver.jdbc.SQLServerDriver");
                        String dbURL = "jdbc:sqlserver://localhost:1433;databaseName=SICT_HAUI;user=sa;password=yourpassword;encrypt=true;trustServerCertificate=true";
                        conn = DriverManager.getConnection(dbURL);
                        stmt = conn.createStatement();

                        String sqlVideo = "SELECT TOP 1 * FROM VideoClip ORDER BY NgayCapNhat DESC";
                        rs = stmt.executeQuery(sqlVideo);
                        if (rs.next()) {
                            String tenVideo = rs.getString("TenVideo");
                            String urlVideo = rs.getString("Url");
                %>
                <p><strong><%= tenVideo %></strong></p>
                <iframe width="100%" height="200" src="<%= urlVideo.replace("watch?v=", "embed/") %>" 
                        title="YouTube video player" frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen></iframe>
                <%
                        }
                        rs.close();
                    } catch (Exception e) {
                        out.println("Error: " + e.getMessage());
                    } finally {
                        if (stmt != null) stmt.close();
                        if (conn != null) conn.close();
                    }
                %>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>