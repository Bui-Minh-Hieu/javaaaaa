package com.sict.servlet;

import com.sict.database.DatabaseConnection;
import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@WebServlet("/news")
public class NewsServlet extends HttpServlet {
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        List<News> newsList = new ArrayList<>();
        Connection conn =	DatabaseConnection.getConnection();
        
        if (conn != null) {
            try {
                String sql = "SELECT TieuDeTinTuc, TrichDanTin, NgayCapNhat FROM TinTuc WHERE MaTheLoai = ? AND MaTheLoaiTin = ? ORDER BY NgayCapNhat DESC";
                PreparedStatement stmt = conn.prepareStatement(sql);
                stmt.setInt(1, 10); // MaTheLoai 10 (TIN TỨC)
                stmt.setInt(2, 1);  // MaTheLoaiTin 1 (THÔNG TIN CHUNG)
                ResultSet rs = stmt.executeQuery();
                
                while (rs.next()) {
                    News news = new News();
                    news.setTitle(rs.getString("TieuDeTinTuc"));
                    news.setSummary(rs.getString("TrichDanTin"));
                    news.setDate(rs.getString("NgayCapNhat"));
                    newsList.add(news);
                }
                
                rs.close();
                stmt.close();
            } catch (SQLException e) {
                e.printStackTrace();
                request.setAttribute("error", "Lỗi truy vấn: " + e.getMessage());
            } finally {
                DatabaseConnection.closeConnection(conn);
            }
        } else {
            request.setAttribute("error", "Kết nối database thất bại!");
        }
        
        request.setAttribute("newsList", newsList);
        request.getRequestDispatcher("/index.jsp").forward(request, response);
    }
}

// Class để lưu trữ thông tin tin tức
class News {
    private String title;
    private String summary;
    private String date;

    public String getTitle() { return title; }
    public void setTitle(String title) { this.title = title; }
    public String getSummary() { return summary; }
    public void setSummary(String summary) { this.summary = summary; }
    public String getDate() { return date; }
    public void setDate(String date) { this.date = date; }
}